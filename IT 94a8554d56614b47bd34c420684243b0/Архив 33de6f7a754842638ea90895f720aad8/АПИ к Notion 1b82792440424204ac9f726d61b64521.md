# АПИ к Notion

Данные берутся из таблиц:

- ‣
- [](https://www.notion.so/a74526e5620f4260b3bbd3b5e4c62b53?pvs=21)
- [](https://www.notion.so/52a27195784548828acf94b4024a9b29?pvs=21)
- [](https://www.notion.so/ea246f2445574f2c8815036b3f4cf12b?pvs=21)

## Справочник «Службы и локации»

Объединяет данные из

- [](https://www.notion.so/52a27195784548828acf94b4024a9b29?pvs=21) — выборка с непустым полем “Волонтёры” или “Участники (не волонтёры)”
- [](https://www.notion.so/ea246f2445574f2c8815036b3f4cf12b?pvs=21) — выборка с непустым полем “Участники (не волонтёры)”

В справочнике два поля:

|  | В таблице направлений | В таблице локаций |
| --- | --- | --- |
| Название | “Кратко для бейджа”, если пусто — Name | “Кратко для бейджа”, если пусто — Локация |
| Руководитель | Руководитель — это будет ссылка на запись из списка кормящихся | *не нужно* |

## Список кормящихся

Объединяет данные из

- ‣ — выборка записей с непустым полем “Волонтёр 2023” или “Организатор 2023”
- [](https://www.notion.so/a74526e5620f4260b3bbd3b5e4c62b53?pvs=21) — без ограничений

Из обеих таблиц исключить записи с пустым “Как звать”

Выгружаются поля:

 

|  | В таблице контактов | В таблице участников | Примечание |
| --- | --- | --- | --- |
| Как звать |  |  |  |
| Фамилия |  |  |  |
| Имя |  |  |  |
| Роль | см. описание ниже | “Роль” | От роли зависит цвет бейджа |
| Цвет |  |  | См. ниже отдельным разделом |
| Служба или локация | объединение из полей
”Волонтёр 2023” и “Организатор 2023”.
если в ”Волонтёр 2023” указано “Ветви дерева”, то вместо этой службы указывается “Локация 2023” | “Локация” если пусто — “Направление” | Связь many-to-many со справочником “Службы и локации” |
| Должность | Должность 2023, Направление 2023, роль | Должность 2023, Роль | см. ниже правила вычисления |
| Тип питания | Питание 2023 | Тип питания | Справочник. Если не указано, применяется значение по умолчанию в зависимости от роли (цвета) |
| Веган |  |  | Логическое |
| Планируемые даты заезда и выезда | Заезд 2023 | Заезд | В ноушене поле даты может содержать диапазон |
| Фото |  |  | Файл |
| Идентификатор для QR |  |  | в прошлом году использовали первые символы из UUID |
| Партия для печати | Партия бейджа | Партия бейджа | Номер. Из наименования «1 партия» получить только число. |
| Номер бейджа |  |  | генерация при выгрузке |

### Вычисление роли в таблице Контактов:

- Если не пустое “Организатор 2023” — Организатор
- Если в “Волонтёр 2023” присутствует “Медпункт” — Медик
- Если в “Волонтёр 2023” присутствует “Ветви дерева” и указана “Локация 2023” — Грант
- Если не пустое “Волонтёр 2023” — Волонтёр
- в противном случае пусто (да и запись такая не выгружается)

### Определение должности

- если указано в поле “Должность”, то оттуда
- если роль “Грант” — название локации (не службы)
- если роль “Волонтёр”, берется название службы
- для остальных берётся роль

### Партия для печати

Данные бейджей выгружаются для печати в несколько партий (в прошлом году было две).

В первой партии выгружались бейджи тех, кто заезжает на строяк рано, а во второй – тех, кто приедет на фестиваль. Это позволяло увеличить время уточнения данных заезжающих на Фест. За полтора месяца многие ещё не могут определиться. Кто-то включается в последний момент.

Важно знать, в какой партии выгружался бейдж для человека (например, чтобы понять, он уже напечатан в первой партии, или ещё не доехал до поля со второй)

Это значение должно сохраняться при выгрузке данных для партии бейджей. и потом передаваться в кормитель. Пока бейдж не выгружен, можно передавать пустое значение.

При этом важно учесть, что бывают случаи, что бейдж человека напечатали в первой партии, а во второй перепечатали во второй, так как были ошибки. В этом случае номер партии должен обновляться.

### Номер бейджа

Технический номер для удобства поиска бейджей в стопке.

Генерируется автоматически при выгрузке на печать и сохраняется для передачи в Кормитель.

Номера генерирующая с учетом удобной сортировки:

- Первая ~~две~~ цифра — ~~роль~~ цвет
- три ~~две~~ цифры — служба или локация (если несколько, берётся любая из списка)
- три ~~две~~  последние цифры — номер внутри службы/локации

### Цвета

Цвет бейджа зависит от роли

| РОЛЬ | ЦВЕТ | ФОРМАТЫ | Питание по умолчанию |
| --- | --- | --- | --- |
| Организатор | Красный | фото, QR | Бесплатно |
| Волонтёр | Зеленый | 1. фото, QR     2.без фото, QR | Бесплатно |
| Медик | Фиолетовый | 1. фото, QR     2.без фото, QR | Бесплатно |
| Грант | Синий | 1. фото, QR     2.без фото, QR | Бесплатно |
| Свои
VIP
Пресса | Желтый | 1. фото, QR     2.без фото, QR 3.без фото, без QR | Без питания |
| Подрядчик | Серый | поле под фото круглое, D 36мм | Без питания |
| Аниматор
Лектор
Мастер
Музыкант
*и прочие* | Оранжевый | 1. фото, QR     2.без фото, QR | Бесплатно |

# Подготовка бейджей

Для печати бейджей требуется выгружать данные в формате, который примет типография — таблицы и архивы с фотографиями

Бейджи выгружаются партиями. При запросе выгрузки указывается, какую партию сейчас выгружаем.

Партия задаётся полем в ноушене “Партия бейджа” (только что добавили).
В нём будет надпись вида “1 партия” или “2 партия”.

Нужно подготовить ендпоинты для выгрузки:

- Всего сразу за указанную партию
- Всех таблиц но без фотографий
- Таблицы и фотографий указанного цвета
- Только таблицы указанного цвета без фоток

[Требования типографии](https://magenta.su/info/article/kak-peredat-peremennye-dannye-dlya-personalizacii-beydzhey.html)

## Данные на бейджи

Данные берутся ровно те же, что выбираются для Кормителя.

Выгружаются в таблицы excel (можно в csv, которое потом легко вгрузить)

**Важно:** таблиц несколько — отдельная таблица на каждый цвет бейджа.

В таблице выводятся столбцы с данными, которые должны пойти на бейдж: 

- Как звать
- Должность
- Номер бейджа
- список названий служб/локаций  — одной строкой с разделением через 5 пробелов
- идентификатор QR
- Имя файла с фото (см. ниже)

## Фотографии

Для отправки бейджей на печать, нужно к каждому файлу-таблице выгрузить из ноушена архив с прикреплёнными к записям фотографиям (в поле “Фото”).

На каждую запись в таблице по одной фотографии. (если их в ноушене несколько – выбрать произвольно)

Названия фотографий должны быть уникальными и соответствовать названиям в соответствующей графе в таблице.

Для записей без фотографий подставляется один общий файл из набора (во все записи без фото пишется имя этого файла). В наборе свой файл для каждого цвета бейджа.

## Безымянные бейджи

Кроме именных бейджей, соответствующих записям в ноушене, нужно генерировать ещё и анонимные бейджи.

Это пачки бейджей с одинаковыми надписями, отличающихся только QR-кодом.

То есть в таблицы для типографии нужно внести столько строк, сколько нужно бейджей, а коды для QR для них нагенерить рандомно.

Данные по основным полям берутся из таблицы  [](../%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B5%D0%B8%CC%86%D0%B4%D0%B6%D0%B8%20a7642109fa214989bfc2471ac23b52e2/%D0%91%D0%B5%D0%B7%D1%8B%D0%BC%D1%8F%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B1%D0%B5%D0%B8%CC%86%D0%B4%D0%B6%D0%B8%20dcb0ace1c2b04375ae68ceb33279d554.md) 

Отбираются строки, в которых проставлена галка QR

Можно добавлять строки анонимных бейджей в общие таблицы по цветам, а можно сделать отдельные таблички чисто для безымянных.

Могут быть бейджи совсем без надписей — только с цветом и QR-кодом. Такие бейджи нужно чтобы по сортировке выносить в конец списка, чтобы при необходимости мы их тоже могли отделить в отдельный файл.

# Старое описание (с 2022 года)

Базы «Направления» и «Локации» используются как справочники для Контактов и Участников.
Из этих таблиц берётся значение «Кратко (для бейджа)». Если оно не указано, то просто Название (Name).

В сводной результирующей таблице должны быть данные:

- Имя
- Позывной
- Должность
- ~~Направление или Локация~~
- Фото
- Цвет бейджа
- Тип питания
- Особенности питания
- Даты заезда и выезда

Есть несколько категорий бейджей, которые обрабатываются по-разному.
Одинаковые у всех только имя, позывной, фото и даты заезда-выезда — из соответствующих полей в таблицах Контакты и Участники. Остальные данные в зависимости от категорий (см. ниже)

Важно учесть, что данные в таблицах не статичные и могут обновляться.
И нужна возможность именно синхронизации изменений, а не заливать всё заново с нуля.

### Организаторы:

Данные из таблицы Контакты, **где заполнено поле** «Руководитель 2022» (важен только факт заполнения. Чем именно — всё равно)

Данные для полей:

- Должность — из поля «Должность». Если пусто — «Организатор»
- Направление или локация — нет
- Цвет бейджа — красный
- Тип питания — бесплатно
- Особенности питания — из столбца «Питание»

### Волонтёры:

Данные из таблицы Контакты, **где заполнено поле** «Волонтёр 2022» и не заполнено «Руководитель 2022».

Данные для полей:

- Должность — из поля «Должность». Если пусто — название службы из поля «Волонтёр 2022». Если несколько, то перечисление через запятую.
- Цвет бейджа — зависит от поля «Волонтёр 2022»
    - зелёный, если служба не «Медпункт»
    - Для медпункта — фиолетовый
- Тип питания — “Бесплатно”, если в столбце «Питание» не указано «самостоятельно»
если «самостоятельно» — без питания
- Особенности питания — из столбца «Питание» (без особенностей / веган / прочие особенности)

### Участники:

Данные из таблицы «Участники (не волонтёры)» без фильтрации по полям.
Тут многое может быть не заполнено. Включая даже Имя.

Данные для полей:

- Должность — из поля «Должность». 
Если должность не заполнена  — из поля «Кто это?», для синих бейджей — из поля «Локация»
- Цвет бейджа — зависит от Службы и категории «Кто это?»:
    - Если служба «Ветви дерева» — синий
    - Если «Кто это» один из: Аниматор, Мастер, Лектор, Музыкант — оранжевый
    - Если «Кто это» Медик — фиолетовый
    - В остальных случаях — Желтый
- Тип питания — из столбца «Тип питания». 
если не указано, значит “Без питания”
- Особенности питания — из столбца «Веган» (либо Веган либо нет)