# А вот же про тестовый стенд

# Контакты и общее описание

Тестовый стенд поднимал [https://t.me/UsCr0](https://t.me/UsCr0) (он же написал первую версию этой страницы)

Крутится всё это на [srv.rumyantsev.com](http://srv.rumyantsev.com/). Доступы получать у [https://t.me/AlexTheDolphin](https://t.me/AlexTheDolphin)

Все скрипты о которых идёть речь лежат в хомяке у автора: `/home/nazarovd/insomnia/`

Конкретно тестовые стенды интегратора базируются в `/home/nazarovd/insomnia/agreemod_testing`

Автор тестового стенда руководствовался двумя принципами:

- поднять тестовый стенд
- опустить порог вхождения в администрирование стендов

## Вот что получилось

- Скрипт который:
    - умеет клонировать репозиторий
    - подсовывать .env файл кастомя в нём порты
    - запускать docker-compose с этим со всем
    - умеет определять дату последнего коммита и перезапускает компоуз если есть новые коммиты в ветке
- Конфиг nginx который проксирует всех подряд с <port>.agreetesting.rumyantsev.com на agreemod:<port>

## В итоге то что?

В итоге, нам нужно выбрать порт такой, который:

- свободен
- свободен его “парный порт”. Парный порт получается дописыванием единички к номеру порта. Например, 9000 и 19000

И мы получаем:

- http на <port>.agreetesting.rumyantsev.com
- psql на порту 1<port>

### А как узнать пароль к БД?

Пароль к БД выводится в консоль во время работы скрипта. Он генерируется по незатейливому алгоритму, пароль легко можно получить зная некоторые параметры стенда.

Алгоритм:

```bash
PSQL_PASSWORD="`echo ${REPODIR}${APPPORT}${REF} | base64`"
```

`REPODIR` это `<имя репозитория без .git>_<port>`

`APPPORT` это http порт

`REF` это ветка

Для стенда поднятого для репозитория https://github.com/Insomnia-IT/agreemod_v2.git из ветки main на 9002 порту переменные примут следующие значения:

`REPODIR` = `agreemod_v2_9002` 

`APPPORT` = `9002`

`REF` = `main` 

Сгенерировать пароль тогда можно такой командой:

```bash
~ % echo 'agreemod_v2_90029002main' | base64
YWdyZWVtb2RfdjJfOTAwMjkwMDJtYWluCg==
```

Можно воспользоваться и онлайн-сервисами. Например: [https://www.base64decode.org/](https://www.base64decode.org/)

## Автоматизация

На момент написания страницы её нет, как нет и понимания подходит ли такая схема стендирования.

# Инструкции

## Как поднять (новый) стенд

- Идём на сервер (см. [Контакты](%D0%90%20%D0%B2%D0%BE%D1%82%20%D0%B6%D0%B5%20%D0%BF%D1%80%D0%BE%20%D1%82%D0%B5%D1%81%D1%82%D0%BE%D0%B2%D1%8B%D0%B8%CC%86%20%D1%81%D1%82%D0%B5%D0%BD%D0%B4%20ac18f9bf117b4d2bbed78d004797f407.md) и увидишь контакты выдавателя доступов)
    
    `ssh myname@srv.rumyantsev.com`
    
- Переходим в каталожик с тестовыми стендами
    
    `cd /home/nazarovd/insomnia/agreemod_testing`
    
    (в примере мы поднимаем тестовый стенд для интегратора, для чего-то ещё нужно идти в  `/home/nazarovd/insomnia/что-то-ещё_testing`)
    
- Определяем свободные порты. Нужно выбрать порт для http, порт для БД будет вычислен автоматически, путём дописывания вначале единички. Например, я хочу взять порт 9002. Значит для БД скрипт возьмёт порт 19002. Проверяю занятость:
    
    ```bash
    sudo netstat -lant | egrep '9002|19002'
    ```
    
    Пустой вывод означает что порт свободен:
    
    ```bash
    [nazarovd@srv agreemod_testing]$ sudo netstat -lant | grep 9002
    [nazarovd@srv agreemod_testing]$
    ```
    
    Если что-то вывелось, значит порт занят, нужно попробовать другой:
    
    ```bash
    [nazarovd@srv ~]$ sudo netstat -lantp | egrep '9000|19000'
    tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN      2362895/docker-prox
    tcp        0      0 0.0.0.0:19000           0.0.0.0:*               LISTEN      2362320/docker-prox
    ```
    
- Порт, который мы выбрали используем в имени скрипта. Делаем симлинк:
    
    ```bash
    ln -s [testing.sh](http://testing.sh/) [testing_9002.sh](http://testing.sh/) 
    ```
    
    Имя ссылки можно указать любое, важно чтобы был потсфикс `_номерпорта.sh`
    
- Запускаем скрипт:
    
    ```bash
    [nazarovd@srv agreemod_testing]$ ./testing_9002.sh
    Cloning into 'agreemod_v2_9000'...
    remote: Enumerating objects: 1154, done.
    remote: Counting objects: 100% (302/302), done.
    remote: Compressing objects: 100% (142/142), done.
    remote: Total 1154 (delta 208), reused 191 (delta 160), pack-reused 852
    Receiving objects: 100% (1154/1154), 1.62 MiB | 5.61 MiB/s, done.
    Resolving deltas: 100% (698/698), done.
    Already on 'main'
    Your branch is up to date with 'origin/main'.
    Already up to date.
    Last commit date: 1712558324, saved commit date: 0
    --------------------
    http://9002.agreetesting.rumyantsev.com
    --------------------
    Postgress user:		agreemod
    Postgress password:	YWdyZWVtb2RfdjJfOTAwMjkwMDJtYWluCg==
    Postgress port:		19002
    --------------------
    Prepare env file...
    Env builded
    Copy compose file...
    ...blablabla...
    Creating agreemod_v2_9001_rabbitmq_1 ... done
    Creating agreemod_v2_9001_postgres_1 ... done
    Creating agreemod_v2_9001_alembic_1  ... done
    Creating agreemod_v2_9001_updater_1  ... done
    Creating agreemod_v2_9001_agreemod_1 ... done
    Apply migrations...
    Skipping virtualenv creation, as specified in config file.
    2024.04.08 08:51:52 [selector_events] [DEBUG]: Using selector: EpollSelector
    2024.04.08 08:51:53 [create_db] [INFO]: Database agreemod already exists.
    INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
    INFO  [alembic.runtime.migration] Will assume transactional DDL.
    INFO  [alembic.runtime.migration] Running upgrade  -> 0bfcc405c30e, init
    INFO  [alembic.runtime.migration] Running upgrade 0bfcc405c30e -> 606a14968f4e, populate_dicts
    INFO  [alembic.runtime.migration] Running upgrade 606a14968f4e -> 6ed374791d11, add_participation
    ```
    
- Это всё! Стенд доступен по адресу http://9002.agreetesting.rumyantsev.com, БД на 19002 порту.

## Проверка стенда

- На [http://9002.agreetesting.rumyantsev.com/api/v1/_docs](http://9002.agreetesting.rumyantsev.com/api/v1/_docs) должен открыться сваггер:
    - Скриншот
        
        ![Untitled](%D0%90%20%D0%B2%D0%BE%D1%82%20%D0%B6%D0%B5%20%D0%BF%D1%80%D0%BE%20%D1%82%D0%B5%D1%81%D1%82%D0%BE%D0%B2%D1%8B%D0%B8%CC%86%20%D1%81%D1%82%D0%B5%D0%BD%D0%B4%20ac18f9bf117b4d2bbed78d004797f407/Untitled.png)
        
- Подключиться к БД можно так:

```bash
psql -h [srv.rumyantsev.com](http://srv.rumyantsev.com/) -U agreemod -p 19002
```

- Переключаемся на схему agremod:

```bash
use agreemod
```

Смотрим таблицы:

```bash
agreemod-# \dt
List of relations
Schema |         Name         | Type  |  Owner
--------+----------------------+-------+----------
public | alembic_version      | table | agreemod
public | arrival              | table | agreemod
public | badge                | table | agreemod
public | badge_color          | table | agreemod
public | direction            | table | agreemod
public | direction_type       | table | agreemod
public | participation        | table | agreemod
public | participation_role   | table | agreemod
public | participation_status | table | agreemod
public | participation_type   | table | agreemod
public | person               | table | agreemod
public | transport_type       | table | agreemod
(12 rows)
```

Таблицы на месте, значит миграции накатились успешно.

## Переподнимаем стенд

Просто запускаем симлинк скрипта для соответствующего порта:

```bash
./testing_9001.sh
```

Скрипт помнит дату последнего коммита для пары репозиторий-порт (ветка не учитывается).  Если новых коммитов нет, ничего не произойдёт. Форсировать переподнятие стенда можно удалив файл сейва:

```bash
rm .<reponame>_<port>_savedcommitdate
```

Например, для стенда на 9001 порту для репы agreemod_v2

```bash
rm .agreemod_v2_9001_savedcommitdate
```

## Уничтожаем стенд (вручную)

Для каждого стенда хранится своя копия репозитория. Например, если мы хотим уничтожить стенд на 9001 порту, следует перейти в соответствующий каталог и остановить компоуз:

```bash
cd /home/nazarovd/insomnia/agreemod_testing/agreemod_v2_9001
docker-compose docker-compose -f agree_docker-compose.yml down
```

Теперь можно удалить каталог и симлинк скрипта:

```bash
rm -rf /home/nazarovd/insomnia/agreemod_testing/agreemod_v2_9001
rm /home/nazarovd/insomnia/agreemod_testing/testing_9001.sh
```

## Запускаем стенд из другой ветки

Следует понимать что скрипты поднимающие стенды симлинкаются на основной скрипт. Если изменить скрипт, изменится поведение всех стендов. Поэтому, если нужно не перевесить все стенды на другую ветку, а поднять рядом новые, то следует скопировать скрипт с другим названием, изменить его и симлинкаться от нового скрипта.

Все настройки в шапке скрипта:

```bash
~$ head -4 [testing.sh](http://testing.sh/)
#!/bin/bash
REPO='[https://github.com/Insomnia-IT/agreemod_v2.git](https://github.com/Insomnia-IT/agreemod_v2.git)'
REF="main"
```

Для переключения на другой репозиторий или ветку достаточно модифицировать эти переменные. Всё остальное скрипт определит сам.

## Меняем конфиг веб-сервера

Конфиг тут: `/etc/nginx/conf.d/PORT.agreetesting.rumyantsev.com.conf` 

Чтобы применить изменения делаем:

```bash
sudo nginx -t && sudo systemctl reload nginx 
```

Не пренебрегайте проверкой конфига (через nginx -t), это не наш выделенный сервер, сервер коммунальный и nginx тоже.

# Листинг скрипта

```bash
#!/bin/bash

REPO='https://github.com/Insomnia-IT/agreemod_v2.git'
REF="main"

cd "$(dirname "$0")"
APPPORT="`echo $0 | awk -F '_' '{print $NF}' | cut -d '.' -f1`"
if [ -z "$APPPORT" ]; then
	echo "make symlink with port specified in link name"
	echo "Like this:"
	echo "ln -s $0 `dirname $0`/something_9000.sh"
	exit 1
fi
REPODIR="`echo $REPO | awk -F '/' '{print $NF}' | cut -d '.' -f1`_$REF_$APPPORT"

PSQL_USER="agreemod"
PSQL_PASSWORD="`echo ${REPODIR}${APPPORT}${REF} | base64`"

if [ -z "$PSQL_PASSWORD" ]; then
        echo "Failed to calculate PSQL_PASSWORD env"
        echo "Check script"
        exit 1
fi

SAVEDCOMMITFILE="`dirname $0`/.${REPODIR}_savedcommitdate"
if [ ! -e $REPODIR ]; then
	git clone $REPO $REPODIR
fi

cd $REPODIR
git checkout $REF
git pull

let lastcommit="`git log -1 --format="%at" | xargs -I{} date -d @{} +%s`"
if [ -e ../${SAVEDCOMMITFILE} ]; then
	let savedcommit="`cat ../${SAVEDCOMMITFILE}`"
else
	let savedcommit=0
fi

echo "Last commit date: $lastcommit, saved commit date: $savedcommit"
echo "--------------------"
echo "http://$APPPORT.agreetesting.rumyantsev.com"
echo "--------------------"
echo "Postgress user:		$PSQL_USER"
echo "Postgress password:	$PSQL_PASSWORD"
echo "Postgress port:		1${APPPORT}"
echo "--------------------"

if [ $lastcommit -gt $savedcommit ]; then
	echo "Do CI"
	echo "Prepare env file..."

	cp .env.example .env
	sed -i \
		-e "s/API_PROXY=.*/API_PROXY=127.0.0.1:${APPPORT}/g" \
		-e "s/VOLUME_MOUNT_PREFIX=.*/VOLUME_MOUNT_PREFIX=\/fakepath/g" \
		-e "s/POSTGRES__PROXY=.*/POSTGRES__PROXY=0.0.0.0:1${APPPORT}/g" \
		-e "s/POSTGRES__USER=.*/POSTGRES__USER=${PSQL_USER}/g" \
		-e "s/POSTGRES__PASSWORD=.*/POSTGRES__PASSWORD=${PSQL_PASSWORD}/g" \
		.env
        if [ $? -eq 0 ]; then echo ".env file builded"; else echo "Failed!"; exit 1; fi
	echo "Run compose..."
	docker-compose up --build -d
	if [ $? -ne 0 ]; then echo "Compose up failed"; exit 1; fi
	echo "Apply migrations..."
	docker-compose exec alembic poetry run alembic upgrade head
	if [ $? -ne 0 ]; then echo "Migrations apply failed"; exit 1; fi
	echo -n $lastcommit > ../${SAVEDCOMMITFILE}
fi
```

# Листинг конфига nginx

```bash
server {
	server_name ~^(?<backport>.+)\.agreetesting.rumyantsev.com;

        root /dev/null;
        autoindex off;
        listen 80;

	location /api/v1 {
    	    proxy_pass http://127.0.0.1:$backport$request_uri;
	}
}
```