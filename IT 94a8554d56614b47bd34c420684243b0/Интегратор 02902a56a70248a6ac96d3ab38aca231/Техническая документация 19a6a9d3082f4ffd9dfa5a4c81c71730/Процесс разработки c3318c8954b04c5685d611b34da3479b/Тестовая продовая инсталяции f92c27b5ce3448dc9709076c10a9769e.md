# Тестовая/продовая инсталяции

Общие подходы к тестингу описаны в описании стендов интегратора [А вот же про тестовый стенд](%D0%90%20%D0%B2%D0%BE%D1%82%20%D0%B6%D0%B5%20%D0%BF%D1%80%D0%BE%20%D1%82%D0%B5%D1%81%D1%82%D0%BE%D0%B2%D1%8B%D0%B8%CC%86%20%D1%81%D1%82%D0%B5%D0%BD%D0%B4%20ac18f9bf117b4d2bbed78d004797f407.md) 

Здесь описаны в основном отличия во флоу для бота промокодов.

# Тестинг

## Поднятие нового тестового стенда

Как описано в [Как поднять (новый) стенд](%D0%90%20%D0%B2%D0%BE%D1%82%20%D0%B6%D0%B5%20%D0%BF%D1%80%D0%BE%20%D1%82%D0%B5%D1%81%D1%82%D0%BE%D0%B2%D1%8B%D0%B8%CC%86%20%D1%81%D1%82%D0%B5%D0%BD%D0%B4%20ac18f9bf117b4d2bbed78d004797f407.md) определяем свободный порт. Нам нужен только один, на нём будет опубликована БД.

Порт, который мы выбрали используем в имени скрипта. Делаем симлинк:

```bash
ln -s /home/nazarovd/insomnia/promocode_bot_testing/testing_promocode_bot.sh /home/nazarovd/insomnia/promocode_bot_testing/testing_promocode_bot_11000.sh
```

В файл /home/nazarovd/insomnia/promocode_bot_testing/11000.bot_token пишем токен тестового бота. Токены, разумеется, должны быть уникальны для каждой инсталляции.

11000 в примерах команд выше следует заменить на порт, на котором будет опубликована БД стенда.

Запускаем скрипт. В консоли смотрим реквизиты новой тестовой БД.

## Автоматизация

На сервере запускается скрипт 1 раз в минуту который дёргает скрипты тестовых стендов. Вот он: `/home/nazarovd/insomnia/cicd/cicd.sh` 

Запуск раз в 1 минуту обеспечивается cron’ом.

В скрипт нужно руками добавить новый стенд по аналогии с предыдущими.

Логи автоматики для единственного (на момент написания статьи) стенда пишутся в 

`/home/nazarovd/insomnia/cicd/testing_promocode_bot_10000.log`

# Прод

Всё как в тесте, только проще.

Скрипт обновляющий прод тут: `/home/nazarovd/insomnia/promocode_bot_production/prod_promocode_bot.sh`

Автоматизации нет. Публикации БД наружу нет.

Запускаем скрипт руками по отмашке ответственных.

## Резервное копирование

Раз в сутки, в 4 утра запускается скрипт резервного копирования.

Скрипт гасит приложение и копирует содержимое вольюмов целиком. Резервные копии складываются вот так:

```bash
/home/nazarovd/insomnia/promocode_bot_production/volume_backups/
├── bot
│   └── bot_prod_bot.2024-04-26-15-27.tar.gz
└── postgres
    └── bot_prod_pg.2024-04-26-15-27.tar.gz
```

В bot вольюмы бота, в postgres вольюмы базёнки. Архивы хранятся 30 дней. Ротация осуществляется скриптом бекапа.

# Листинги скриптов

## Листинг скрипта тестового стенда

`/home/nazarovd/insomnia/promocode_bot_testing/testing_promocode_bot.sh`

```bash
#!/bin/bash

REPO='https://PASTE_TOKEN_HERE@github.com/Insomnia-IT/promocode_bot.git'
REF="master"

cd "$(dirname "$0")"
PSQL_PORT="`echo $0 | awk -F '_' '{print $NF}' | cut -d '.' -f1`"
if [ -z "$PSQL_PORT" ]; then
	echo "make symlink with port specified in link name"
	echo "Like this:"
	echo "ln -s $0 `dirname $0`/something_9000.sh"
	exit 1
fi
REPODIR="`echo $REPO | awk -F '/' '{print $NF}' | cut -d '.' -f1`_${REF}_${PSQL_PORT}"

PSQL_USER="giver_bot"
PSQL_PASSWORD="`echo ${REPODIR}${PSQL_PORT}${REF} | base64`"

BOT_TOKEN=`cat ${PSQL_PORT}.bot_token`
if [ -z "$BOT_TOKEN" ]; then
        echo "Create ${PSQL_PORT}.bot_token file with token"
        exit 1
fi

ADMINS='"genkush","the_livingstone","UsCr0","afagorn","wotorii","KseniaS_F"'

if [ -z "$PSQL_PASSWORD" ]; then
        echo "Failed to calculate PSQL_PASSWORD env"
        echo "Check script"
        exit 1
fi

SAVEDCOMMITFILE=$1
if [ -z "$SAVEDCOMMITFILE" ]; then
	SAVEDCOMMITFILE=".${REPODIR}_savedcommitdate"
fi
if [ ! -e $REPODIR ]; then
	git clone $REPO $REPODIR
fi

cd $REPODIR
git checkout $REF
git pull

let lastcommit="`git log -1 --format="%at" | xargs -I{} date -d @{} +%s`"
if [ -e ../${SAVEDCOMMITFILE} ]; then
	let savedcommit="`cat ../${SAVEDCOMMITFILE}`"
else
	let savedcommit=0
fi

echo "Last commit date: $lastcommit, saved commit date: $savedcommit"
echo "--------------------"
echo "http://$PSQL_PORT.agreetesting.rumyantsev.com"
echo "--------------------"
echo "Postgress user:		$PSQL_USER"
echo "Postgress password:	$PSQL_PASSWORD"
echo "Postgress port:		${PSQL_PORT}"
echo "--------------------"

if [ $lastcommit -gt $savedcommit ]; then
	echo "Do CI"
	echo "Prepare env file..."
	cp .env.example .env
	sed -i \
		-e "s/POSTGRES_PROXY=.*/POSTGRES_PROXY=0.0.0.0:${PSQL_PORT}/g" \
		-e "s/POSTGRES_USER=.*/POSTGRES_USER=${PSQL_USER}/g" \
		-e "s/POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=${PSQL_PASSWORD}/g" \
		.env
        if [ $? -eq 0 ]; then echo ".env file builded"; else echo "Failed!"; exit 1; fi
	echo "Prepare config file..."
	cp ../config.toml .
	sed -i \
		-e "s/%BOT_TOKEN%/${BOT_TOKEN}/g" \
		-e "s/%ADMINS%/${ADMINS}/g" \
		-e "s/%PSQL_USER%/${PSQL_USER}/g" \
		-e "s/%PSQL_PASSWORD%/${PSQL_PASSWORD}/g" \
		config.toml
	cp ../hardcoded_hr.txt hardcoded_hr.txt
	cp ../hardcoded_org.txt hardcoded_org.txt
	echo "Run compose..."
	/usr/local/bin/docker-compose -f docker-compose.yml up --build -d
	sleep 30
	sudo chmod -R 777 .docker-volumes
	/usr/local/bin/docker-compose -f docker-compose.yml restart bot
	echo -n $lastcommit > ../${SAVEDCOMMITFILE}
fi
```

## Листинг скрипта прода

`/home/nazarovd/insomnia/promocode_bot_production/prod_promocode_bot.sh`

```bash
#!/bin/bash

REPO='https://PASTE_TOKEN_HEREP@github.com/Insomnia-IT/promocode_bot.git'
REF="master"

cd "$(dirname "$0")"
PSQL_PORT="5432"
REPODIR="`echo $REPO | awk -F '/' '{print $NF}' | cut -d '.' -f1`_${REF}"

PSQL_USER="giver_bot"
PSQL_PASSWORD="`echo ${REPODIR}${PSQL_PORT}${REF} | base64`"

BOT_TOKEN=`cat bot_token`
if [ -z "$BOT_TOKEN" ]; then
        echo "Create ${PSQL_PORT}.bot_token file with token"
        exit 1
fi

ADMINS='"genkush","the_livingstone","UsCr0","afagorn","wotorii"'

if [ -z "$PSQL_PASSWORD" ]; then
        echo "Failed to calculate PSQL_PASSWORD env"
        echo "Check script"
        exit 1
fi

SAVEDCOMMITFILE=$1
if [ -z "$SAVEDCOMMITFILE" ]; then
	SAVEDCOMMITFILE=".${REPODIR}_savedcommitdate"
fi
if [ ! -e $REPODIR ]; then
	git clone $REPO $REPODIR
fi

cd $REPODIR
git checkout $REF
git pull

let lastcommit="`git log -1 --format="%at" | xargs -I{} date -d @{} +%s`"
if [ -e ../${SAVEDCOMMITFILE} ]; then
	let savedcommit="`cat ../${SAVEDCOMMITFILE}`"
else
	let savedcommit=0
fi

echo "Last commit date: $lastcommit, saved commit date: $savedcommit"

if [ $lastcommit -gt $savedcommit ]; then
	echo "Do CI"
	echo "Prepare env file..."
	cp .env.example .env
	sed -i \
		-e "s/POSTGRES_PROXY=.*/POSTGRES_PROXY=127.0.0.1:${PSQL_PORT}/g" \
		-e "s/POSTGRES_USER=.*/POSTGRES_USER=${PSQL_USER}/g" \
		-e "s/POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=${PSQL_PASSWORD}/g" \
		.env
        if [ $? -eq 0 ]; then echo ".env file builded"; else echo "Failed!"; exit 1; fi
	echo "Prepare config file..."
	cp ../config.toml .
	sed -i \
		-e "s/%BOT_TOKEN%/${BOT_TOKEN}/g" \
		-e "s/%ADMINS%/${ADMINS}/g" \
		-e "s/%PSQL_USER%/${PSQL_USER}/g" \
		-e "s/%PSQL_PASSWORD%/${PSQL_PASSWORD}/g" \
		config.toml
	cp ../hardcoded_hr.txt hardcoded_hr.txt
	cp ../hardcoded_org.txt hardcoded_org.txt
	echo "Run compose..."
	/usr/local/bin/docker-compose -f docker-compose.yml up --build -d
	sleep 30
	sudo chmod -R 777 .docker-volumes
	/usr/local/bin/docker-compose -f docker-compose.yml restart bot
	echo -n $lastcommit > ../${SAVEDCOMMITFILE}
fi
```

## Листинг скрипта бекапа

`/home/nazarovd/insomnia/promocode_bot_production/backup_volumes.sh`

```bash
#!/bin/bash

BACKUP_PATH="/home/nazarovd/insomnia/promocode_bot_production/volume_backups"

COMPOSE_PATH="/home/nazarovd/insomnia/promocode_bot_production/promocode_bot_master"

PG_VOLUME_PATH="/home/nazarovd/insomnia/promocode_bot_production/promocode_bot_master/.docker-volumes/postgres"
BOT_VOLUME_PATH="/home/nazarovd/insomnia/promocode_bot_production/promocode_bot_master/.docker-volumes/bot_uploaded_data"

mkdir ${BACKUP_PATH}/{postgres,bot} >/dev/null 2>&1

cd $COMPOSE_PATH
docker-compose -f docker-compose.yml down
sudo tar cfz ${BACKUP_PATH}/postgres/bot_prod_pg.`date +%Y-%m-%d-%H-%M`.tar.gz ${PG_VOLUME_PATH}
sudo tar cfz ${BACKUP_PATH}/bot/bot_prod_bot.`date +%Y-%m-%d-%H-%M`.tar.gz ${BOT_VOLUME_PATH}
docker-compose -f docker-compose.yml up -d

find ${BACKUP_PATH}/postgres -type f -mtime +30 -delete
find ${BACKUP_PATH}/bot -type f -mtime +30 -delete
```