# План Гены синхронизация Участия

Затея с плагином у нас идёт туго. Так что давайте переориентируемся на работу с Кодой по API.

Общую схему потоков данных по Участию я зарисовал вот тут:
[https://www.figma.com/file/zO4sbqKdZGdYUtd7VhGLDj/Insomnia-IT?type=whiteboard&node-id=435-984&t=zbZ32OVsE2qylp4M-4](https://www.figma.com/file/zO4sbqKdZGdYUtd7VhGLDj/Insomnia-IT?type=whiteboard&node-id=435-984&t=zbZ32OVsE2qylp4M-4)

Но есть этого слона нужно по частям:

# Синхронизация Участия из Коды и Ноушен

## Получение Участия из Коды

1. Нужно научиться забирать обновления из таблицы Участие в Coda.
Для начала только в одну сторону — из Коды к себе.
В схему данных тогда нужно будет добавить идентификатор записи в Coda, чтобы по нему сопоставлять данные.
Так как там каждый год будет набегать минимум по тысяче записей, выкачивать её полностью и сравнивать со своей базой — так себе вариант. Но на MVP возможно покатит.
Это отменяет задачу по разовой первичной заливке данных из Коды [https://www.notion.so/insomniafest/23-24-Coda-d175e6771a18468698810f106b498581?pvs=4](../../%D0%A0%D0%B0%D0%B7%D0%B2%D0%B8%D1%82%D0%B8%D0%B5%20%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0%20%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8%CC%86%2005a1ab68bcbe453cbe07f9fb28fe8965/%D0%A1%D0%BA%D1%80%D0%B8%D0%BF%D1%82%20%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20%D0%A3%D1%87%D0%B0%D1%81%D1%82%D0%B8%D1%8F%20%D0%B7%D0%B0%2023%20%D0%B8%2024%20%D0%B3%D0%BE%D0%B4%20%D0%B8%D0%B7%20%D0%B4%20d175e6771a18468698810f106b498581.md) , которая была актуальна только для перехода на использование плагина. Если мы продолжим использовать имеющуюся таблицу, значит данные загрузятся в штатном режиме.

1а) Нужно думать над механизмом дифференциального обновления. В Coda можно завести поле последнего обновления записи (а может быть такое скрытое значение и так есть в API). И наверняка должен быть в API способ сделать выборку по этому полю.
Так что мы можем у себя хранить значение последнего синхронизированного обновления, и выкачивать только свежие записи.
Но тут может быть проблема с удалением записей — они в выборку вероятно не будут попадать. Тогда придётся таки делать иногда полное сопоставление таблиц целиком.

## Получать Участие оргов из Ноушен

2. Нужно научиться получать из Notion данные о руководителях направлений и записывать Участие к себе, а потом передавать их в Coda. [https://www.notion.so/insomniafest/2024-dc092e9712e840a7bd0c73390f4c6650?pvs=4](../../%D0%A0%D0%B0%D0%B7%D0%B2%D0%B8%D1%82%D0%B8%D0%B5%20%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0%20%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8%CC%86%2005a1ab68bcbe453cbe07f9fb28fe8965/%D0%9E%D0%B4%D0%BD%D0%BE%D1%81%D1%82%D0%BE%D1%80%D0%BE%D0%BD%D0%BD%D1%8F%D1%8F%20%D1%81%D0%B8%D0%BD%D1%85%D1%80%20%D0%A3%D1%87%D0%B0%D1%81%D1%82%D0%B8%D1%8F%20%D0%BF%D0%BE%20%D0%BE%D1%80%D0%B3%D0%B0%D0%BC%20%D0%B8%20%D0%B7%D0%B0%D0%BC%D0%B0%D0%BC%20%D0%B8%D0%B7%20No%20dc092e9712e840a7bd0c73390f4c6650.md)
Тут записей относительно немного — порядка сотни. Так что вполне допустимо забирать из ноушена все данные, сопоставлять со своей базой, находить совпадающие и добавлять недостающие.
Причем тут нам не нужно делать удаление — если в нашей базе обнаруживается запись руководителя, которого больше нет в Ноушене, то просто меняем статус участия на CANCELED.

## Отправить любое Участие в Коду

2а) И дальше нужно заливать эти изменения обратно в Коду. Чтобы избежать конфликтов можно выполнять получение из Ноушена и заливку в Коду сразу после получения обновлений из Коды (которое сделано в первой задаче).
Тут логично использовать поле идентификатора Коды — если это поле пустое, значит запись нужно в Коду добавить, получить её идентификатор и сохранить.

## Отправить Участие волонтеров в Ноушен

А, ну и никуда не девается задача отправки данных по Участию в Notion
[https://www.notion.so/insomniafest/Notion-Updater-a2c6a91c066349bf9713eb74ce77335d?pvs=4](../../%D0%A0%D0%B0%D0%B7%D0%B2%D0%B8%D1%82%D0%B8%D0%B5%20%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0%20%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8%CC%86%2005a1ab68bcbe453cbe07f9fb28fe8965/%D0%9E%D0%B4%D0%BD%D0%BE%D1%81%D1%82%D0%BE%D1%80%D0%BE%D0%BD%D0%BD%D1%8F%D1%8F%20%D1%81%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%A3%D1%87%D0%B0%D1%81%D1%82%D0%B8%D1%8F%20%D0%B8%D0%B7%20%D0%91%D0%94%20%D0%B2%20Notion%20a2c6a91c066349bf9713eb74ce77335d.md)

Обращу ещё раз внимание, что тут движение данных одностороннее — только из Интегратора в Notion. Забирать Участия из ноушена не нужно

## Одноразовый скрипт сбора прошлых Участий из Ноушена таблицы контакты

3. Одноразовая заливка данных об Участиях прошлых лет.
[https://www.notion.so/insomniafest/21-22-Notion-4e61de3f0aea4be4b2e234e9d0770678?pvs=4](../../%D0%A0%D0%B0%D0%B7%D0%B2%D0%B8%D1%82%D0%B8%D0%B5%20%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0%20%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8%CC%86%2005a1ab68bcbe453cbe07f9fb28fe8965/%D0%A1%D0%BA%D1%80%D0%B8%D0%BF%D1%82%20%D0%B7%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20%D0%A3%D1%87%D0%B0%D1%81%D1%82%D0%B8%D1%8F%20%D0%B7%D0%B0%2021%20%D0%B8%2022%20%D0%B3%D0%BE%D0%B4%20%D0%B8%D0%B7%20N%204e61de3f0aea4be4b2e234e9d0770678.md)
Тут нужно выполнить разовый скрипт, который вытащить из "Базы контактов" в Notion данные об участии в прошлые годы и создаст соответствующие записи Участия.
А эти записи зальются по механизму, разработанному в 2а.

# Грузить Бейджы(?) из гугл таблицы

4. Заливка данных при импорте из Гугл-таблицы.
Это описано в отдельной задаче [https://www.notion.so/insomniafest/Google-Spreadsheet-6a8869570d5545949e529bce6268c389?pvs=4](../../%D0%A0%D0%B0%D0%B7%D0%B2%D0%B8%D1%82%D0%B8%D0%B5%20%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0%20%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8%CC%86%2005a1ab68bcbe453cbe07f9fb28fe8965/%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0%20%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%BE%D0%BC%20%D0%B8%D0%B7%20Google%20Spreadsheet%206a8869570d5545949e529bce6268c389.md)

5. Обновление статусов Участия при изменении статуса Заезда в Кормителе.
Про это тоже будет в отдельной задаче

# Остальное

Также будут задачи по работе с Бейжами, Заездами, и Фотками
Но вот Фотки точно придётся делать через плагин, чтоб не переваливать их через хранилище самой Коды.
И возможно придумаем активацию некоторых заливок через кнопку в плагине. Но это не то чтобы очень приоритетно. Можно и ботом дергать.

И ещё — раз мы отходим от использования плагина, то и реализация API для него тоже теряет актуальность.
Его можно будет дописать, чтобы в перспективе попробовать ещё раз поиграть в плагин или прикрутить какие-то ещё инструменты взаимодействия. Но это теперь не приоритетно.

@afagorn [https://www.notion.so/insomniafest/API-Coda-101c98d009014d43847510c5589e4030?pvs=4](../../%D0%A0%D0%B0%D0%B7%D0%B2%D0%B8%D1%82%D0%B8%D0%B5%20%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0%20%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8%CC%86%2005a1ab68bcbe453cbe07f9fb28fe8965/%D0%A1%D0%B8%D0%BD%D1%85%D1%80%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%A3%D1%87%D0%B0%D1%81%D1%82%D0%B8%D0%B5%20%D1%87%D0%B5%D1%80%D0%B5%D0%B7%20API%20Coda%20101c98d009014d43847510c5589e4030.md)
вот эту твою пространную задачу про интеграцию с Coda через API, вероятно, стоит разбить на несколько. Чтобы есть слона по частям