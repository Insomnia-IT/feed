# version: '3.8'

services:
  chrome:
    networks:
      - tests
    # image: selenium/standalone-chromium:latest
    image: selenium/standalone-chromium:135.0
    hostname: chrome
    privileged: true
    shm_size: 2g
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/wd/hub/status"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 15s
  backend:
    networks:
      - tests
    build:
      context: ..
      dockerfile: Dockerfile_backend
      args:
        SYNC_URL:
        SYNC_LOGIN:
        SYNC_PASSWORD:
    container_name: feed_backend
    restart: always
    environment:
      # OTEL_ENDPOINT: http://jaeger:4318/v1/traces
      SKIP_BACK_SYNC: ${SKIP_BACK_SYNC:-False}
      PHOTO_AUTH_TOKEN: ${PHOTO_AUTH_TOKEN}
    volumes:
      - db:/app/db
      - photos:/app/photos
    # depends_on:
    #   - jaeger

  front:
    networks:
      - tests
    build:
      context: ..
      dockerfile: ./Dockerfile_front
      args:
        NEW_API_URL: http://localhost:${PORT:-80}/feedapi/v1
    container_name: feed_front
    restart: always
    ports:
      - ${PORT:-80}:80
    depends_on:
      - backend
  tests:
    networks:
      - tests
    environment:
      WEBDRIVER_REMOTE: true
      FEED_APP_HOST: ${FEED_APP_HOST:-feed_front}
    build:
      context: .
      network: host
    command: bash -c "python -m pytest --count=$NREPS test_regress.py"
    depends_on:
      chrome:
        condition: service_healthy
      front:
        condition: service_started
  # pinger: # for troubleshoot
  #   build:
  #     context: .
  #     network: host
  #   # network_mode: host
  #   command: bash -c "ping google.com -c 3 ; sleep 1s"

  # easy_test: # for example
  #   build:
  #     context: .
  #     network: host
  #   command: python -m pytest --count=$NREPS test_minimal.py

networks:
  tests:

volumes:
  db:
  photos: