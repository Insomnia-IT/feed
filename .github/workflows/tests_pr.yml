name: Tests Merged

# on:
#   workflow_dispatch:
#   push:
#     branches: [main]

on:
  workflow_run:
    workflows: ["Deploy to rumsrv on PR"]
    types: [completed]
  # pull_request:
  #   branches: [main]
  #   types: [opened, synchronize, reopened, edited]
# on:
#   pull_request:
#     branches: [main]
#     types: [opened, synchronize, reopened, edited]

jobs:
  tests:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, rumsrv]

    steps:
      - uses: actions/checkout@v3
#       - name: Checkout base branch
#         uses: actions/checkout@v4
#         with:
#           ref: ${{ github.event.pull_request.base.ref }}
#           path: base
#           fetch-depth: 0

#       - name: Checkout PR branch
#         uses: actions/checkout@v4
#         with:
#           ref: ${{ github.head_ref }}
#           path: pr
#           fetch-depth: 0

#       - name: Merge PR into base
#         run: |
#           cd base
#           git fetch ../pr HEAD
#           git merge --no-ff --no-commit FETCH_HEAD
#         continue-on-error: false



      - name: ‚åõ Do Testing
        env:
          FEED_APP_HOST: https://9${{ github.event.workflow_run.pull_requests[0].number }}.feedapp-dev.insomniafest.ru
        run: |
          cd tests
          echo $FEED_APP_HOST
          bash run_tests.sh || touch /tmp/testFailed

      - name: üçè Shorter Log
        run: cat /tmp/tests.short.log

      - name: Verdict
        run: if [ -f /tmp/testFailed ]; then
          echo "Tests Failed!"; exit 1;
          else
          echo "Tests Success!";
          fi